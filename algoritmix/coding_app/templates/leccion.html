<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lección {{ leccion }} - Módulo {{ modulo }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ace.js"></script>

    <style>
        #editor {
            height: 50vh; /* 50% de la pantalla */
            width: 100%;
            border: 1px solid #ddd;
        }

        #consola {
            height: 50vh; /* 50% de la pantalla */
            width: 100%;
            background-color: #333; /* Fondo oscuro */
            padding: 15px;
            border-top: 1px solid #ccc;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap; /* Mantiene los saltos de línea */
            line-height: 1.5em;
            color: #ffffff; /* Texto blanco */
        }

        .instructions {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            height: 100%;
            overflow-y: auto;
        }

        .col-left {
            height: 100vh; /* Full height */
            overflow-y: auto;
        }

        .col-right {
            height: 100vh;
        }

        .input-prompt {
            color: #28a745; /* Color verde para el prompt */
            font-weight: bold;
        }

        .console-text {
            white-space: pre-wrap; /* Mantiene el formato del texto */
            color: #ffffff; /* Blanco por defecto */
        }

        .error-text {
            color: #ff4d4d; /* Rojo para los errores */
            font-weight: bold;
        }

        .input-field {
            display: inline-block;
            width: auto;
            background-color: transparent;
            color: #ffffff;
            border: none;
            outline: none;
            font-family: monospace;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Columna Izquierda: Instrucciones -->
            <div class="col-md-4 col-left">
                <div class="instructions">
                    <h3>Instrucciones</h3>
                    <p>{{ contenido }}</p>
                </div>
            </div>

            <!-- Columna Derecha: Editor de Código + Consola -->
            <div class="col-md-8 col-right">
                <div class="row" style="height: 100%;">
                    <!-- Parte superior: Editor de código -->
                    <div class="col-12" style="height: 50%;">
                        <h3>Escribe tu código Python:</h3>
                        <button class="btn btn-primary mb-2" onclick="ejecutarCodigo()">Ejecutar Código</button>
                        <div id="editor"></div>
                    </div>

                    <!-- Parte inferior: Consola de resultados (con input) -->
                    <div class="col-12" style="height: 50%;">
                        <h4 class="mt-4">Consola:</h4>
                        <div id="consola" class="console-text"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/python");

        let consola = document.getElementById('consola');
        let inputBuffer = ''; // Buffer para la entrada del usuario
        let inputPending = false; // Bandera para saber si se espera un input

        function ejecutarCodigo() {
            const codigo = editor.getValue();

            // Mostrar el mensaje de ejecución en la consola
            mostrarSalida(">>> Ejecutando el código...\n");

            fetch('/ejecutar_codigo/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({ codigo: codigo }),
            })
            .then(response => response.json())
            .then(data => {
                // Mostrar los resultados del código en la consola
                mostrarSalida(data.resultado);
            })
            .catch(error => {
                // En caso de error en la ejecución
                mostrarSalida('Error: ' + error, true);
            });
        }

        // Mostrar la salida en la consola
        function mostrarSalida(salida, esError = false) {
            let consolaOutput = document.createElement('div');
            consolaOutput.textContent = salida;
            if (esError) {
                consolaOutput.classList.add('error-text');
            }
            consola.appendChild(consolaOutput);
            consola.scrollTop = consola.scrollHeight;
        }

        // Solicitar el input del usuario
        function solicitarInput(prompt) {
            inputPending = true; // Establecemos que se espera input
            mostrarSalida(`>>> ${prompt}`, false); // Mostrar el prompt en la consola

            // Crear un campo de entrada en la consola
            let inputField = document.createElement('input');
            inputField.type = 'text';
            inputField.classList.add('input-field');
            inputField.placeholder = 'Ingresa tu respuesta...';
            inputField.focus();

            // Evento cuando se presiona "Enter"
            inputField.addEventListener('keypress', function (event) {
                if (event.key === 'Enter') {
                    const valorInput = inputField.value;
                    if (valorInput) {
                        consola.appendChild(document.createElement('br'));
                        mostrarSalida(valorInput); // Mostrar lo que el usuario ingresó

                        inputBuffer = valorInput; // Guardamos el valor en el buffer
                        inputField.remove(); // Eliminamos el campo de entrada

                        inputPending = false; // Ya no esperamos input
                        ejecutarCodigoConInput(); // Ejecutar el código con el input
                    }
                }
            });

            consola.appendChild(inputField);
        }

        // Ejecutar el código con el input del usuario
        function ejecutarCodigoConInput() {
            const codigo = editor.getValue();
            const codigoConInput = `${codigo}\ninput_value = "${inputBuffer}"`; // Agregamos el valor del input al código

            // Ejecutar el código modificado en el servidor
            fetch('/ejecutar_codigo/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({ codigo: codigoConInput }),
            })
            .then(response => response.json())
            .then(data => {
                mostrarSalida(data.resultado);
            })
            .catch(error => {
                mostrarSalida('Error: ' + error, true);
            });
        }

        // Verificar si el código necesita entrada
        function verificarInputEnCodigo(codigo) {
            const inputPattern = /input\(\)/g;
            if (inputPattern.test(codigo)) {
                solicitarInput("Introduce un valor para continuar");
            }
        }
    </script>
</body>

</html>
